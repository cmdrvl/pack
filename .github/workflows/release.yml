name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.1.0)"
        required: true
        type: string
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine version and tag
        id: version
        shell: bash
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
            TAG="v${VERSION}"
          else
            TAG="${GITHUB_REF_NAME}"
            VERSION="${TAG#v}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          echo "Release version: ${VERSION}"
          echo "Release tag: ${TAG}"

      - name: Validate Cargo.toml version
        shell: bash
        run: |
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | sed 's/.*"\(.*\)"/\1/')
          RELEASE_VERSION="${{ steps.version.outputs.version }}"
          echo "Cargo.toml version: ${CARGO_VERSION}"
          echo "Release version:    ${RELEASE_VERSION}"
          if [ "${CARGO_VERSION}" != "${RELEASE_VERSION}" ]; then
            echo "Version mismatch: Cargo.toml (${CARGO_VERSION}) != release (${RELEASE_VERSION})"
            echo "Update Cargo.toml version before releasing."
            exit 1
          fi

  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: [validate]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
            cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux aarch64)
        if: matrix.cross
        run: cargo install cross --locked

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-${{ matrix.target }}-cargo-release-

      - name: Build (native)
        if: "!matrix.cross"
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        run: cross build --release --locked --target ${{ matrix.target }}

      - name: Package (unix)
        if: matrix.archive == 'tar.gz'
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_NAME="pack-${VERSION}-${{ matrix.target }}"
          mkdir -p "staging/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/pack" "staging/${ARCHIVE_NAME}/pack"
          cp README.md "staging/${ARCHIVE_NAME}/README.md"
          cp LICENSE "staging/${ARCHIVE_NAME}/LICENSE"
          cd staging
          tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
          echo "ARCHIVE_PATH=staging/${ARCHIVE_NAME}.tar.gz" >> "$GITHUB_ENV"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}.tar.gz" >> "$GITHUB_ENV"

      - name: Package (windows)
        if: matrix.archive == 'zip'
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          ARCHIVE_NAME="pack-${VERSION}-${{ matrix.target }}"
          mkdir -p "staging/${ARCHIVE_NAME}"
          cp "target/${{ matrix.target }}/release/pack.exe" "staging/${ARCHIVE_NAME}/pack.exe"
          cp README.md "staging/${ARCHIVE_NAME}/README.md"
          cp LICENSE "staging/${ARCHIVE_NAME}/LICENSE"
          cd staging
          7z a "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"
          echo "ARCHIVE_PATH=staging/${ARCHIVE_NAME}.zip" >> "$GITHUB_ENV"
          echo "ARCHIVE_NAME=${ARCHIVE_NAME}.zip" >> "$GITHUB_ENV"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARCHIVE_NAME }}
          path: ${{ env.ARCHIVE_PATH }}
          retention-days: 14

      - name: Reproduction hint
        if: failure()
        shell: bash
        run: |
          echo "Build failed for ${{ matrix.target }}."
          echo "Reproduce locally with:"
          echo "  cargo build --release --locked --target ${{ matrix.target }}"

  publish:
    name: Publish Release
    runs-on: ubuntu-latest
    needs: [validate, build]
    steps:
      - uses: actions/checkout@v4

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Flatten artifact directories
        shell: bash
        run: |
          cd artifacts
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} . \;
          find . -type d -empty -delete
          ls -la

      - name: Generate SHA256SUMS
        shell: bash
        run: |
          cd artifacts
          sha256sum *.tar.gz *.zip > SHA256SUMS
          echo "--- SHA256SUMS ---"
          cat SHA256SUMS

      - name: Generate SBOM
        shell: bash
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          TAG="${{ needs.validate.outputs.tag }}"
          cat > artifacts/sbom.spdx.json << SBOM_EOF
          {
            "spdxVersion": "SPDX-2.3",
            "dataLicense": "CC0-1.0",
            "SPDXID": "SPDXRef-DOCUMENT",
            "name": "pack-${VERSION}",
            "documentNamespace": "https://github.com/${{ github.repository }}/releases/tag/${TAG}",
            "creationInfo": {
              "created": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "creators": ["Tool: github-actions"],
              "licenseListVersion": "3.19"
            },
            "packages": [
              {
                "SPDXID": "SPDXRef-Package",
                "name": "pack",
                "versionInfo": "${VERSION}",
                "downloadLocation": "https://github.com/${{ github.repository }}/releases/tag/${TAG}",
                "filesAnalyzed": false,
                "licenseConcluded": "MIT",
                "licenseDeclared": "MIT",
                "copyrightText": "Copyright (c) 2026 CMD+RVL"
              }
            ]
          }
          SBOM_EOF

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: artifacts/SHA256SUMS

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag }}
          name: "pack ${{ needs.validate.outputs.version }}"
          body: |
            ## pack ${{ needs.validate.outputs.version }}

            ### Verification

            ```bash
            sha256sum -c SHA256SUMS
            ```

            ### Attestation

            Verify build provenance:
            ```bash
            gh attestation verify pack-*-*.tar.gz -R ${{ github.repository }}
            ```
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
            artifacts/SHA256SUMS
            artifacts/sbom.spdx.json
          fail_on_unmatched_files: false
          generate_release_notes: true

      - name: Reproduction hint
        if: failure()
        shell: bash
        run: |
          echo "Publish failed. Check:"
          echo "  1. Tag ${{ needs.validate.outputs.tag }} exists"
          echo "  2. GitHub token has contents:write permission"
          echo "  3. Artifacts downloaded correctly (check build job)"
